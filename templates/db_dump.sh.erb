#!/bin/bash
# This file is managed by Puppet
SCRIPTNAME=$(basename $0)

logger "PE_FAILOVER: ${SCRIPTNAME} ---> Starting dump of database: <%= @db_name %>"

# Create Export
su - pe-postgres -s '/bin/bash' -c "<%= @pg_dump_command %> -C <%= @db_name %> -f <%= @dump_path %>/<%= @db_name %>/<%= @db_name %>_latest.psql"
result="$?"
if [[ $result -eq 0 ]]; then
  logger "PE_FAILOVER: ${SCRIPTNAME} ---> Completed dump of database: <%= @db_name %>"
else
  logger "PE_FAILOVER: ${SCRIPTNAME} ---> Failed to dump database <%= @db_name %>. Exit code is: ${result}"
fi

# Create MD5SUM file for Export
<%= @md5sum_command %> <%= @dump_path %>/<%= @db_name %>/<%= @db_name %>_latest.psql > <%= @dump_path %>/<%= @db_name %>/<%= @db_name %>_latest.psql.md5sum

if [ $? -ne 0 ]; then
  logger "PE_FAILOVER: ${SCRIPTNAME} ---> Failed to create MD5Sum for export!"
fi
